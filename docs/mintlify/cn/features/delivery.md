---
title: "配送系统"
description: "溢出保护，当存储空间已满时购买物品不会消失。"
---

配送是购买物品无法放入目标存储（持仓或背包）时的安全网。

## 解决什么问题

如果目标存储已满，剩余物品会进入**配送队列**而不是丢失。

## 典型流程

```text
购买 -> 尝试存入 -> 溢出 -> 配送队列 -> 稍后领取
```

## 玩家命令（典型）

```text
/market delivery list
/market delivery claim <material> [amount]
/market delivery claim-all
```

<Warning>
领取配送通常需要空闲的背包空间。
</Warning>

## 技巧

<Info>
如果玩家报告"我的物品消失了"，首先检查他们的配送队列。
</Info>

### 领取所有

领取所有待处理的配送：

```
/market delivery claim-all
```

领取到背包（不是持仓），最多可用空间。

### 配送 GUI

直接打开配送 GUI：

```
/market delivery gui
```

---

## 配送 GUI

### 界面

```
┌─────────────────────────────────────────────────┐
│              待处理配送                          │
│              总计：232 件物品                    │
├─────────────────────────────────────────────────┤
│                                                 │
│  [钻石] ×40         [绿宝石] ×128               │
│  点击：领取全部      点击：领取全部              │
│  右键：领取 64       右键：领取 64               │
│                                                 │
│  [金锭] ×64                                     │
│  点击：领取全部                                  │
│                                                 │
├─────────────────────────────────────────────────┤
│      ◀ 返回      │     📦 领取所有物品          │
└─────────────────────────────────────────────────┘
```

### 交互

| 操作 | 结果 |
|--------|--------|
| **左键点击**物品 | 领取该材料的全部 |
| **右键点击**物品 | 领取一组（64） |
| **领取全部**按钮 | 领取所有能放下的 |

---

## 从市场 GUI 访问

主市场 GUI 显示配送状态：

1. 打开 `/market`
2. 查看槽位 51（末影箱图标）
3. 徽章显示待处理物品数量
4. 点击打开配送面板

---

## 配置

```yaml
delivery:
  # 启用配送系统
  enabled: true
  
  # 玩家登录时自动领取配送
  auto-claim-on-login: false
  
  # 每个玩家的最大待处理物品数
  max-pending-per-player: 100000
```

### 登录时自动领取

启用后：
- 玩家加入服务器
- 系统检查待处理配送
- 自动领取到背包
- 通知玩家已领取的物品

```yaml
delivery:
  auto-claim-on-login: true
```

---

## 存储

配送存储在 SQLite 数据库中：

```
plugins/TheEndex/deliveries.db
```

特性：
- 事务安全
- 防止重复利用漏洞
- 服务器重启后保留
- 按玩家跟踪

---

## 限制

### 最大待处理数

配置每个玩家的最大待处理物品数：

```yaml
delivery:
  max-pending-per-player: 100000
```

**达到限制时：**
- 购买失败
- 通知玩家
- 必须先领取现有配送

### 背包空间

领取时：
- 系统检查可用背包槽位
- 只领取能放下的
- 剩余留在队列中

---

## 防止物品丢失

配送系统有多重保护措施：

| 保护措施 | 保护内容 |
|-----------|------------|
| **数据库优先** | 给予物品前先从数据库删除 |
| **事务安全** | 原子操作防止损坏 |
| **空间检查** | 不会领取超过能放下的 |
| **断线保护** | 断开连接时物品安全 |

---

## 网页仪表盘

可从网页仪表盘访问配送：

### 查看配送

```
GET /api/deliveries
```

### 从浏览器领取

```
POST /api/deliveries/claim
{
  "material": "DIAMOND",
  "amount": 64
}
```

或领取全部：
```
POST /api/deliveries/claim
{}
```

---

## 故障排除

### 物品未显示

1. 检查 `/market delivery list`
2. 验证配置中 `delivery.enabled: true`
3. 检查是否达到 max-pending 限制

### 无法领取物品

1. 检查背包空间
2. 尝试领取较少数量
3. 清空背包后重试

### 丢失的配送

配送不应该丢失。如果物品消失：
1. 检查服务器日志是否有错误
2. 验证数据库文件存在
3. 联系支持并提供日志

---

## 技巧

<Tip>
**定期领取**  
不要让配送堆积。定期领取以保持空间可用。
</Tip>

<Info>
**先清空背包**  
批量领取前，清空背包以获得最大空间。
</Info>

<Warning>
**持仓 vs 配送**  
从配送领取的物品进入背包，不是持仓。与购买不同！
</Warning>

---

## 相关页面

- [虚拟持仓](holdings) — 主要存储系统
- [市场 GUI](market-gui) — 配送面板访问
- [REST API](../web-api/rest-api) — 配送端点
